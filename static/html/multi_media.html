<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="author" content="doudou">
    <meta name="description" content="用代码、文字、图像记录新事物、新思想、新生活">
    <title>multi_media</title>
    <link rel="stylesheet" href="/static/css/base.css">
    <style>
        @media screen and (min-width: 1200px) { 
            body{ width: 70rem; text-align: center;}
            #site { z-index: -1;}
            #itemlist { position: fixed; height: 70rem; width: 20rem; overflow: auto; left: 1rem; top: 0px; }
            #itemlist li {
                border: 1px solid #fff; /* 链接添加边框 */
                background-color: rgb(231, 239, 244);
                padding: 6px; 
                text-decoration: none;
                font-size: 16px; 
                color: black; 
                display: block; cursor: pointer; 
            }
            #info { position: fixed; width: 20rem; height: 70rem; overflow: auto; right: 1rem; top: 0px;}
            #dplayer { display: inline-block; }
            #items_search {
                padding: 6px; 
                border: 1px solid #fff;
                background-color: rgb(231, 239, 244);
                outline: none;
            }
        }
        @media screen and (max-width: 1200px) { 
            #site { width: 100%; display: flex; align-items:flex-start;}
            #itemlist { height: 350px; width: 40%; overflow: auto; }
            #itemlist li {
                border: 1px solid #ddd; /* 链接添加边框 */
                background-color: #f6f6f6; 
                padding: 6px; 
                text-decoration: none;
                font-size: 16px; 
                color: black; 
                display: block; cursor: pointer; 
            }
            #info { width: 60%; height: 350px; overflow: auto; }
            #dplayer { display: inline-block; }
            #items_search {
                padding: 6px; 
                border: 1px solid #ddd; 
                margin-top: 6px;
            }
        }


    </style>
</head>
<body>
    <div class="sites">
        <a href="#" class="button" onclick="switch_site('epub_epubee')">epubee</a>
        <a href="#" class="button" onclick="switch_site('m3u8_avhd101')">avhd101</a>
        <a href="#" class="button" onclick="switch_site('m3u8_e3xd')">e3xd</a>
        <a href="#" class="button" onclick="switch_site('m3u8_wie2')">wie2</a>
        <a href="#" class="button" onclick="switch_site('m3u8_zyk2')">zyk2</a>
        <a href="#" class="button" onclick="switch_site('mp3_qqmusic')">qqmusic</a>
        <a href="#" class="button" onclick="switch_site('mp4_av')">av</a>
        <a href="#" class="button" onclick="switch_site('mp4_dy')">dy</a>
        <a href="#" class="button" onclick="switch_site('jpg_fuliba')">fuliba</a>
    </div>
    <div id="site">
        <div id="itemlist"></div>
        <div id="info"></div>
    </div>
    <div id="dplayer"></div>
    <div id="page_nav"></div>
    <script src="/static/js/hls.min.js"></script>
    <script src="/static/js/DPlayer.min.js"></script>
    <script src="/static/js/util.js"></script>
    <script src="/static/js/func.js"></script>
    <script src="/static/js/router.js"></script>
    <script>
        // var site_meta = {saved: "false", current_page_num: "1", per_page_num: "16", disk='a'},
        //     csv_arr = []
            // page_num = 1,
            // per_page_num = 16,
            // item_num = 0,
            // db_version = 2,
            // disk = 'a';


        function csv2db(key, data, db) {
            var csv_items = data.replace(/\r/g, '').split("\n"),
                csv_arr = [];
            csv_items.forEach(item => {
                if (item) {
                    csv_arr.push(item.split(','));
                }
            });
            
            db.add(key, csv_arr);
            return csv_arr;

        }

        function switch_site(site) {
            var site_meta = {name: "", type: "", saved: "false", all_item_num: "", current_page_num: "1", per_page_num: "16", disk: 'a'},
                csv_arr = [],
                meta = site.split("_");
            site_meta.name = meta[1];
            site_meta.type = meta[0];
            if (localStorage.getItem(site) == null) {
                // window.site_meta.saved = "false";
                localStorage.setItem(site, JSON.stringify(site_meta));
            } else {
                site_meta = JSON.parse(localStorage.getItem(site));
            }
            var db = func.dbObject;
            db.init({
                db_name: "multi_media",
                db_version: 1,
                db_store_name: "multi_media"
            }, function() {
                if (site_meta.saved == "true") {
                    db.select(site_meta.name, function() {
                        csv_arr = db.result[site_meta.name];
                        gen_itemlist(csv_arr, site_meta);
                        gen_pagemeta(csv_arr, site_meta);
                    });
                } else {
                    func.ajax(
                        "get",
                        "/"+site_meta.disk+"/"+site_meta.name+"/"+site_meta.name+".csv",
                        function(data) {
                            csv_arr = csv2db(site_meta.name, data, db);
                            site_meta.saved = "true";
                            site_meta.all_item_num = csv_arr.length;
                            localStorage.setItem(site, JSON.stringify(site_meta));
                            gen_itemlist(csv_arr, site_meta);
                            gen_pagemeta(csv_arr, site_meta);
                        }
                    )
                }
            });
        }

        function gen_itemlist(csv_arr, site_meta) {
            if (csv_arr.length > 1) {
                let a = parseInt(site_meta.current_page_num),
                    b = parseInt(site_meta.per_page_num),
                    current_csv_arr = csv_arr.slice((a-1)*b, a*b),
                    all_item = document.createElement('ul');

                current_csv_arr.forEach(item => {
                    if (item[0]) {
                        let li_item = document.createElement('li');
                        li_item.addEventListener('click', function() {
                            var dp = new DPlayer({
                                container: document.getElementById('dplayer'),
                                video: {
                                    url: '',
                                    type: 'auto'
                                },
                                pluginOptions: {
                                    hls: {
                                        // hls config
                                    },
                                }
                            }),
                            item_index = current_csv_arr.indexOf(item);
                            if (site_meta.type == "m3u8") {
                                dp.on("ended", function() {
                                    item_index = item_index + 1;
                                    switch_m3u8(dp, site_meta, current_csv_arr[item_index][0]);
                                    dp.play();
                                });
                                switch_m3u8(dp, site_meta, item[0]);
                            } else if (site_meta.type == "mp4") {
                                dp.on("ended", function() {
                                    item_index = item_index + 1;
                                    switch_mp4(dp, site_meta, current_csv_arr[item_index][0]);
                                    dp.play();
                                });
                                switch_mp4(dp, site_meta, item[0]);
                            }
                        })
                        li_item.innerText = item[1];
                        all_item.appendChild(li_item);
                    }
                });
                var itemlist = func.$('#itemlist')[0]
                itemlist.innerHTML = '';
                let items_search = document.createElement('input'),
                    next_page = document.createElement('label');
                items_search.setAttribute('type', 'text');
                items_search.setAttribute('id', 'items_search');
                items_search.addEventListener('keyup', function(e) {my_search(e);});
                items_search.setAttribute('placeholder', '搜索'+csv_arr.length+'项');
                
                itemlist.appendChild(items_search);
                itemlist.appendChild(all_item);
            }
        }

    function gen_pagemeta(csv_arr, site_meta) {
        let all_page_num = Math.ceil(site_meta.all_item_num/site_meta.per_page_num),
            page_nav = func.$("#page_nav")[0],
            prev = document.createElement('a'),
            next = document.createElement('a'),
            half = document.createElement('a'),
            page_count = document.createElement("span"),
            page_index = document.createElement("span"),
            clear_meta = document.createElement('a');
        prev.setAttribute('href', '#');
        prev.setAttribute('class', 'button');
        prev.textContent = "上一页"

        next.setAttribute('href', '#');
        next.setAttribute('class', 'button');
        next.textContent = "下一页";

        half.setAttribute('href', '#');
        half.setAttribute('class', 'button');
        half.textContent = "二分页";

        clear_meta.setAttribute('href', '#');
        clear_meta.setAttribute('class', 'button');
        clear_meta.textContent = "重置";

        clear_meta.addEventListener("click", function() {
            localStorage.removeItem(site_meta.type+"_"+site_meta.name);
        });
        prev.addEventListener('click', function() {
            if (site_meta.current_page_num > 1) {
                site_meta.current_page_num --;
            } else {
                site_meta.current_page_num = all_page_num;
            }
            page_index.textContent="当前页: "+site_meta.current_page_num;
            localStorage.setItem(site_meta.type+"_"+site_meta.name, JSON.stringify(site_meta));
            gen_itemlist(csv_arr, site_meta);;
        });
        next.addEventListener('click', function() {
            if (site_meta.current_page_num < all_page_num) {
                site_meta.current_page_num ++;
            } else {
                site_meta.current_page_num = 1;
            }
            page_index.textContent="当前页: "+site_meta.current_page_num;
            localStorage.setItem(site_meta.type+"_"+site_meta.name, JSON.stringify(site_meta));
            gen_itemlist(csv_arr, site_meta);;
        });
        half.addEventListener('click', function() {
            if (site_meta.current_page_num > 1) {
                site_meta.current_page_num = Math.ceil(site_meta.current_page_num/2);
            } else {
                site_meta.current_page_num = 1;
            }
            page_index.textContent="当前页: "+site_meta.current_page_num;
            localStorage.setItem(site_meta.type+"_"+site_meta.name, JSON.stringify(site_meta));
            gen_itemlist(csv_arr, site_meta);;
        });
        page_count.textContent="总页数: "+all_page_num+' ';
        page_index.textContent="当前页: "+site_meta.current_page_num+' ';
        
        page_nav.innerHTML = '';
        page_nav.appendChild(prev);
        page_nav.appendChild(next);
        page_nav.appendChild(half);
        page_nav.appendChild(page_count);
        page_nav.appendChild(page_index);
        page_nav.appendChild(clear_meta);
    }
    

            // func.ajax(
            //     "get",
            //     '/temp/sites/'+site_meta[1]+".csv",
            //     function(data) {
            //         var csv_items = data.replace(/\r/g, '').split("\n");
            //         csv_items.forEach(item => {
            //             window.csv_arr.push(item.split(','));
            //         });
            //         if (csv_arr.length > 1) {
            //             let all_item = document.createElement('ul');
            //             csv_arr.forEach(element => {
            //                 var info = element;
            //                 if (info[0]) {
            //                     let vid_item = document.createElement('li');
            //                     vid_item.setAttribute('onclick', "switch_m3u8(dp, '"+site_meta[1]+"', '"+info[0]+"')");
            //                     vid_item.innerText = info[1];
            //                     all_item.appendChild(vid_item);
            //                 }
            //             });
            //             var itemlist = func.$('#itemlist')[0]
            //             itemlist.innerHTML = '';
            //             let items_search = document.createElement('input'),db_saved
            //                 result_num = document.createElement('label');
            //             items_search.setAttribute('type', 'text');
            //             items_search.setAttribute('id', 'items_search');
            //             items_search.addEventListener('keyup', function(e) {my_search(e);});
            //             items_search.setAttribute('placeholder', '搜索...');
            //             result_num.textContent = "条目数："+(csv_arr.length-1);
                        
            //             itemlist.appendChild(items_search);
            //             itemlist.appendChild(result_num);
            //             itemlist.appendChild(all_item);
            //         }
            //     }
            // );


        function switch_m3u8(dp, site_meta, path) {
            func.ajax(
                "get",
                '/'+site_meta.disk+"/"+site_meta.name+"/"+path+"/info.html",
                function(data) {
                    cover = '<img src="/'+site_meta.disk+'/'+site_meta.name+'/'+path+'/cover.jpg">';
                    func.$("#info")[0].innerHTML = cover+data;
                }
            );
            dp.switchVideo(
                {
                    url: '/'+site_meta.disk+"/"+site_meta.name+"/"+path+'/hls.m3u8',
                }
            );
        }

        function switch_mp4(dp, site_meta, path) {
            func.ajax(
                "get",
                '/'+site_meta.disk+"/"+site_meta.name+"/"+path+".html",
                function(data) {
                    cover = '<img src="/'+site_meta.disk+'/'+site_meta.name+'/'+path+'.jpg">';
                    func.$("#info")[0].innerHTML = cover+data;
                }
            );
            dp.switchVideo(
                {
                    url: '/'+site_meta.disk+"/"+site_meta.name+"/"+path+'.mp4',
                }
            );
        }

        function my_search(e) {
            if (e.key=="Enter") {
                var input = document.getElementById('items_search');
                csv_arr = window.csv_arr;

                if (csv_arr.length > 1) {
                    let all_item = document.createElement('ul');
                    csv_arr.forEach(element => {
                        var info = element.split(',');
                        if (info[0]) {
                            let title = '';
                            if (window.site == 'e3xd') {
                                title = info[4];
                            } else {
                                title = info[1];
                            }
                            if (title.search(input.value) >-1) {
                                let vid_item = document.createElement('li');
                                vid_item.setAttribute('onclick', "switch_m3u8(dp, '"+site+"', '"+info[0]+"')");
                                vid_item.innerText = info[1]+'/'+info[3]+'/'+info[4];
                                all_item.appendChild(vid_item);
                                item_num += 1;
                            }
                        }
                    });
                    var itemlist = func.$('#itemlist')[0]
                    itemlist.innerHTML = '';
                    let items_search = document.createElement('input'),
                        result_num = document.createElement('label');
                    items_search.setAttribute('type', 'text');
                    items_search.setAttribute('id', 'items_search');
                    items_search.addEventListener('keyup', function(e) {my_search(e);});
                    items_search.setAttribute('placeholder', '搜索...');
                    result_num.textContent = "条目数："+(csv_arr.length-1);
                    
                    itemlist.appendChild(items_search);
                    itemlist.appendChild(result_num);
                    itemlist.appendChild(all_item);
                    result_num.textContent = "条目数："+item_num;
                    item_num = 0;
                }
            }
        }



    </script>
</body>
</html>